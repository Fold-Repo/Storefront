<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>GrapesJS + Page Manager + Working Drag & Drop</title>

    <!-- GrapesJS core + plugins -->
    <link href="https://unpkg.com/grapesjs/dist/css/grapes.min.css" rel="stylesheet" />
    <link href="https://unpkg.com/grapesjs-project-manager/dist/grapesjs-project-manager.min.css" rel="stylesheet" />
    <script src="https://unpkg.com/grapesjs"></script>
    <script src="https://unpkg.com/grapesjs-blocks-basic"></script>
    <script src="https://unpkg.com/grapesjs-tailwind"></script>
    <script src="https://unpkg.com/grapesjs-project-manager"></script>

    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        font-family: "Segoe UI", Roboto, sans-serif;
        background: #f9fafb;
        overflow: hidden;
      }

      .editor-wrapper {
        display: flex;
        flex-direction: row;
        height: 100vh;
        width: 100vw;
        overflow: hidden;
      }

      #blocks {
        width: 260px;
        background: #f3f4f6;
        border-right: 1px solid #ddd;
        overflow-y: auto;
      }

      #gjs {
        flex: 1;
        overflow: hidden;
      }

      @media (max-width: 768px) {
        #blocks {
          position: fixed;
          left: -260px;
          top: 0;
          height: 100%;
          z-index: 2000;
        }
        #blocks.active {
          left: 0;
        }
        .toggle-blocks {
          position: fixed;
          top: 10px;
          left: 10px;
          background: #111827;
          color: #fff;
          border: none;
          border-radius: 6px;
          padding: 8px 10px;
          z-index: 2100;
        }
      }
    </style>
  </head>

  <body>
    <button class="toggle-blocks" onclick="document.getElementById('blocks').classList.toggle('active')">‚ò∞ Blocks</button>

    <div class="editor-wrapper">
      <div id="blocks"></div>
      <div id="gjs"></div>
    </div>

    <script>
      async function loadBlocks() {
        try {
          const res = await fetch('./blocks/blocks.json');
          if (!res.ok) throw new Error('Failed to load blocks.json');
          const data = await res.json();
          return data;
        } catch (err) {
          console.warn('‚ö†Ô∏è No external blocks.json found, using defaults.');
          // fallback default blocks
          return {
            Header: [
              {
                label: 'Header 1',
                category: 'Header',
                content: "<header style='background:#333; color:#fff; padding:10px;'><h1>Header</h1></header>"
              }
            ],
            Hero: [
              {
                label: 'Hero 1',
                category: 'Hero Section',
                content: "<section style='background:#eee; padding:50px; text-align:center;'><h2>Hero Area</h2><p>Welcome here!</p></section>"
              }
            ]
          };
        }
      }

      document.addEventListener('DOMContentLoaded', async () => {
        const blocksData = await loadBlocks();

        const editor = grapesjs.init({
          container: '#gjs',
          height: '100vh',
          storageManager: false,
          blockManager: { appendTo: '#blocks' },
          pageManager: true,
          plugins: ['grapesjs-blocks-basic', 'grapesjs-tailwind', 'grapesjs-project-manager'],
          pluginsOpts: {
            'grapesjs-blocks-basic': { flexGrid: true },
          },
        });

        // ‚úÖ Add JSON blocks synchronously
        Object.keys(blocksData).forEach(category => {
          blocksData[category].forEach(block => {
            editor.BlockManager.add(block.label.toLowerCase().replace(/\s+/g, '-'), {
              label: block.label,
              category: block.category,
              content: block.content,
            });
          });
        });

        // === PAGE MANAGER BUTTONS ===
        const pn = editor.Panels;
        pn.addButton('options', {
          id: 'open-templates',
          className: 'fa fa-folder-o',
          attributes: { title: 'Open Projects / Templates' },
          command: 'open-templates',
        });
        pn.addButton('views', {
          id: 'open-pages',
          className: 'fa fa-file-o',
          attributes: { title: 'Manage Pages' },
          command: 'open-pages',
          togglable: false,
        });
        pn.addButton('options', {
          id: 'new-page',
          className: 'fa fa-plus',
          attributes: { title: 'Create New Page' },
          command: 'create-new-page',
        });

        editor.Commands.add('create-new-page', {
          run() {
            const name = prompt('Enter page name:');
            if (!name) return;
            const id = name.toLowerCase().replace(/\s+/g, '-');
            editor.Pages.add({
              id,
              name,
              component: `<h1>${name}</h1><p>Edit your content here.</p>`
            });
            editor.Pages.select(id);
          },
        });

        // === Add default pages ===
        if (editor.Pages.getAll().length === 0) {
          editor.Pages.add({
            id: 'home',
            name: 'Home Page',
            component: '<h1>üè† Home Page</h1><p>Start editing here.</p>'
          });
          editor.Pages.select('home');
        }

        // ‚úÖ Full reinitialization of drag-drop AFTER load
        editor.on('load', () => {
          setTimeout(() => {
            const bm = editor.BlockManager;
            bm.render();
            editor.refresh();
            editor.Canvas.getBody().dispatchEvent(new Event('mouseup'));
            editor.Canvas.render();
            console.log('‚úÖ Drag & Drop fully reinitialized.');
          }, 500);
        });

        editor.setComponents('<h1>‚úÖ GrapesJS Drag & Drop Fixed with JSON Blocks</h1>');
      });
    </script>
  </body>
</html>
